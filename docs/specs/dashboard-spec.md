# 講師・教室長用ダッシュボード (Teacher Dashboard) - 技術仕様書

## 1. コンセプト (Concept)
**「努力の可視化 (Quantified Effort)」**

**学習時間（滞在時間）** と **通塾日数** の2軸で生徒の頑張りを定量化し、評価・称賛するためのツール。
生徒の学習モチベーション向上と、講師による的確な指導サポートを目的とします。

## 2. 実装済み機能 (Implemented Features)

### A. ダッシュボード画面 (UI Specification)
`/dashboard` ルートで提供され、権限（講師・教室長）を持つユーザーのみアクセス可能です。

#### アクセス方法
| 方法 | 対象 | 説明 |
| :--- | :--- | :--- |
| **LINE LIFF** | 講師・教室長 | LINEアプリ内でポータルにアクセスし、ダッシュボードリンクをタップ |
| **Google OAuth** | 院内PC | `/dashboard` にアクセスし、「Googleでログイン」から `seras.gakuin@gmail.com` でログイン |


#### 1. フィルターコマンドバー (FilterCommandBar)
画面上部にスティッキー表示される操作パネルです。
*   **期間選択 (Period)**: 以下のプリセットと月別アーカイブから選択可能。
    *   直近7日間 / 14日間 / 30日間 / 90日間 / 180日間 / 全期間
    *   月別アーカイブ（例: 2024年4月）
*   **学年フィルター (Grade)**:
    *   全学年 / 中学生 / 高校生 / 受験生 (中3・高3・既卒) / 各学年個別

#### 2. KPI カード (KPI Section)
全体の傾向を把握するための主要指標を表示します。`Skeleton` UIにより読み込み中もレイアウトが崩れません。
*   **総学習時間**: 指定期間内の全生徒の合計学習時間。
*   **延べ通塾人数**: 指定期間内に来塾した「のべ人数」。
*   **トップ学習者**: 指定期間内で最も学習時間の長い生徒と、その時間。

#### 3. 累積学習時間グラフ (Cumulative Growth Chart)
生徒の学習の積み上げを可視化したラインチャートです。**Recharts** を使用。
*   **日次累積**: 開始日を0とし、日々の学習時間を積み上げて表示。努力の継続が一目でわかります。
*   **インタラクティブな凡例 (Interactive Legend)**:
    *   **比較機能**: 通常はトップ学習者のみ（または全員）を表示し、凡例リストから生徒を選択（クリック）することで特定の生徒同士のグラフを比較表示できます。
    *   **アフォーダンス**: ホバー時に「+」アイコン、選択時に「✓」アイコンを表示し、直感的な操作を促します。
    *   **スティッキーヘッダー**: 生徒リストが長くても、ヘッダー（順位・クリアボタン）は常に上部に固定されます。

#### 4. 学習時間ランキング (Ranking Widget)
詳細な数値データを確認するリスト表示です。ロード時は半透明 (`opacity: 0.5`) になり、スクロール位置を維持したままデータ更新されます。
*   **項目**: 順位、名前、学年、学習時間、通塾日数、通塾率 (出席率)。
*   **相対評価バー**: トップの生徒を基準とした相対的な長さをバーで可視化。

## 3. データ処理ロジック (Data Logic)

### Backend API (`/api/dashboard/stats`)
フロントエンドからのリクエストパラメータ（`from`, `to`, `grade`）に基づき、集計データを返却します。

### 集計・計算ロジック (`src/services/dashboardService.ts`)

1.  **データ取得**:
    *   `src/repositories/googleSheets/GoogleSheetStudentRepository` 経由で、スプレッドシートの全ログデータを取得します。
    *   パフォーマンス向上のため、適切なキャッシュ戦略 (`unstable_cache`) が適用される場合があります。

2.  **滞在時間計算**:
    *   `退室時刻 - 入室時刻` で算出します。
    *   **欠損値補完**:
        *   `退室時刻` が未記入の場合、入室時刻から**4時間後**、または**当日22:00（閉館時間）**のいずれか早い方を仮の退室時刻として計算します（最大4時間キャップ）。
        *   これにより、退室忘れによる異常な長時間記録（例: 24時間）を防ぎます。

3.  **通塾日数計算**:
    *   1日に複数回入退室しても、「1日」としてカウントします（Unique Date Count）。

4.  **除外条件**:
    *   滞在時間が極端に短い（例: 5分未満）レコードは、ノイズとして集計から除外するロジックが含まれています。

## 4. UI/UX 設計指針 (UI/UX Guidelines)

*   **ゼロ・レイアウトシフト**: データのロード中に画面がガタついたり、スクロール位置がリセットされたりすることを防ぎます。
    *   **初回ロード**: `Skeleton` コンポーネントを使用。
    *   **再ロード（フィルタ変更）**: コンテンツを表示したまま不透明度を下げ、操作不能状態を示します。
*   **Glassmorphism**: アプリケーション全体で統一された、すりガラス風のデザイン言語を使用します (`GlassCard`)。
*   **レスポンシブ**: スマートフォンからPCまで、画面サイズに応じてグリッドレイアウト (`grid-template-columns`) が最適化されます。

## 5. 週間ランキング・バッジシステム (Weekly Champions / Badge System)

### A. コンセプト
生徒の多様な頑張りを称えるためのゲーミフィケーション機能です。単純な「総学習時間」だけでなく、様々な観点から生徒の努力を可視化・表彰します。

### B. バッジ種別 (Badge Types)

| バッジ名 | 技術名 | アイコン | 判定基準 |
| :--- | :--- | :--- | :--- |
| トップランカー | `HEAVY_USER` | Crown | 総学習時間が上位 |
| 早起きマスター | `EARLY_BIRD` | Sunrise | 9:00以前の学習時間が長い（30分以上） |
| 深夜マスター | `NIGHT_OWL` | Moon | 20:00以降の学習時間が長い（1時間以上） |
| 皆勤賞候補 | `CONSISTENT` | CalendarDays | 通塾日数が多い（3日以上） |
| 長時間マスター | `MARATHON` | Timer | 1回あたりの平均滞在時間が長い |
| 急上昇 | `RISING_STAR` | Zap | 前期間比で学習時間が大幅増加（2時間以上） |

### C. データ処理 (`src/services/badgeService.ts`)

1.  **集計期間**: ローリング7日間（前日終了、毎日更新）
    *   終了日 = 前日 23:59:59
    *   開始日 = 終了日の6日前 00:00:00
2.  **グループ分け**: 受験生（高3・既卒）と非受験生で別々にランキングを算出
3.  **返却形式**: `{ exam: StudentBadgesMap, general: StudentBadgesMap }`

### D. UI表示

#### Occupancy ページ (`ChampionsCard`)
*   生徒向けに表示される週間ランキングカード
*   ログインユーザーの属性に応じて「受験生部門」または「非受験生部門」を自動選択
*   講師・教室長は「受験生部門」をデフォルト表示

#### Dashboard ページ (`RankingWidget`)
*   ランキングテーブル内にバッジアイコンを表示
*   Lucide React アイコン使用（ブランドカラー適用）

## 6. 今後の拡張予定 (Future Roadmap)
*   **個人詳細ページ**: ランキングの生徒名をクリックした際に、個人の詳細な学習推移やヒートマップを表示するモーダルまたはページの実装。
*   **データエクスポート**: 表示中のデータをCSV等でダウンロードする機能。
*   **バッジ通知**: 新たにランクインした生徒にLINE通知を送信する機能。

