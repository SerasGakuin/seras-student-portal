# 講師・教室長用ダッシュボード (Teacher Dashboard) - 技術仕様書

## 1. コンセプト (Concept)
**「努力の可視化 (Quantified Effort)」**

**学習時間（滞在時間）** と **通塾日数** の2軸で生徒の頑張りを定量化し、評価・称賛するためのツール。
生徒の学習モチベーション向上と、講師による的確な指導サポートを目的とします。

## 2. 実装済み機能 (Implemented Features)

### A. ダッシュボード画面 (UI Specification)
`/dashboard` ルートで提供され、権限（講師・教室長）を持つユーザーのみアクセス可能です。

#### アクセス方法
| 方法 | 対象 | 説明 |
| :--- | :--- | :--- |
| **LINE LIFF** | 講師・教室長 | LINEアプリ内でポータルにアクセスし、ダッシュボードリンクをタップ |
| **Google OAuth** | 院内PC | `/dashboard` にアクセスし、「Googleでログイン」から `seras.gakuin@gmail.com` でログイン |


#### 1. フィルターコマンドバー (FilterCommandBar)
画面上部にスティッキー表示される操作パネルです。
*   **期間選択 (Period)**: 以下のプリセットと月別アーカイブから選択可能。
    *   直近7日間 / 14日間 / 30日間 / 90日間 / 180日間 / 全期間
    *   月別アーカイブ（例: 2024年4月）
*   **学年フィルター (Grade)**:
    *   全学年 / 中学生 / 高校生 / 受験生 (中3・高3・既卒) / 各学年個別

#### 2. KPI カード (KPI Section)
全体の傾向を把握するための主要指標を表示します。`Skeleton` UIにより読み込み中もレイアウトが崩れません。
*   **総学習時間**: 指定期間内の全生徒の合計学習時間。
*   **延べ通塾人数**: 指定期間内に来塾した「のべ人数」。
*   **トップ学習者**: 指定期間内で最も学習時間の長い生徒と、その時間。

#### 3. 累積学習時間グラフ (Cumulative Growth Chart)
生徒の学習の積み上げを可視化したラインチャートです。**Recharts** を使用。
*   **日次累積**: 開始日を0とし、日々の学習時間を積み上げて表示。努力の継続が一目でわかります。
*   **インタラクティブな凡例 (Interactive Legend)**:
    *   **比較機能**: 通常はトップ学習者のみ（または全員）を表示し、凡例リストから生徒を選択（クリック）することで特定の生徒同士のグラフを比較表示できます。
    *   **アフォーダンス**: ホバー時に「+」アイコン、選択時に「✓」アイコンを表示し、直感的な操作を促します。
    *   **スティッキーヘッダー**: 生徒リストが長くても、ヘッダー（順位・クリアボタン）は常に上部に固定されます。

#### 4. 学習時間ランキング (Ranking Widget)
詳細な数値データを確認するリスト表示です。ロード時は半透明 (`opacity: 0.5`) になり、スクロール位置を維持したままデータ更新されます。
*   **項目**: 順位、名前、学年、学習時間、通塾日数、通塾率 (出席率)。
*   **相対評価バー**: トップの生徒を基準とした相対的な長さをバーで可視化。

## 3. データ処理ロジック (Data Logic)

### Backend API (`/api/dashboard/stats`)
フロントエンドからのリクエストパラメータ（`from`, `to`, `grade`）に基づき、集計データを返却します。

### 集計・計算ロジック (`src/services/dashboardService.ts`)

1.  **データ取得**:
    *   `src/repositories/googleSheets/GoogleSheetStudentRepository` 経由で、スプレッドシートの全ログデータを取得します。
    *   パフォーマンス向上のため、適切なキャッシュ戦略 (`unstable_cache`) が適用される場合があります。

2.  **滞在時間計算**:
    *   `退室時刻 - 入室時刻` で算出します。
    *   **欠損値補完**:
        *   `退室時刻` が未記入の場合、入室時刻から**4時間後**、または**当日22:00（閉館時間）**のいずれか早い方を仮の退室時刻として計算します（最大4時間キャップ）。
        *   これにより、退室忘れによる異常な長時間記録（例: 24時間）を防ぎます。

3.  **通塾日数計算**:
    *   1日に複数回入退室しても、「1日」としてカウントします（Unique Date Count）。

4.  **除外条件**:
    *   滞在時間が極端に短い（例: 5分未満）レコードは、ノイズとして集計から除外するロジックが含まれています。

## 4. UI/UX 設計指針 (UI/UX Guidelines)

*   **ゼロ・レイアウトシフト**: データのロード中に画面がガタついたり、スクロール位置がリセットされたりすることを防ぎます。
    *   **初回ロード**: `Skeleton` コンポーネントを使用。
    *   **再ロード（フィルタ変更）**: コンテンツを表示したまま不透明度を下げ、操作不能状態を示します。
*   **Glassmorphism**: アプリケーション全体で統一された、すりガラス風のデザイン言語を使用します (`GlassCard`)。
*   **レスポンシブ**: スマートフォンからPCまで、画面サイズに応じてグリッドレイアウト (`grid-template-columns`) が最適化されます。

## 5. 週間ランキング・バッジシステム (Weekly Champions / Badge System)

### A. コンセプト
生徒の多様な頑張りを称えるためのゲーミフィケーション機能です。単純な「総学習時間」だけでなく、様々な観点から生徒の努力を可視化・表彰します。

### B. バッジ種別 (Badge Types)

| バッジ名 | 技術名 | アイコン | 判定基準 | 閾値 |
| :--- | :--- | :--- | :--- | :--- |
| トップランカー | `HEAVY_USER` | Crown | 総学習時間が上位 | 0分超 |
| 早起きマスター | `EARLY_BIRD` | Sunrise | **4:00〜9:00 JST** の学習時間が長い | 30分以上 |
| 深夜マスター | `NIGHT_OWL` | Moon | **20:00〜24:00 JST** の学習時間が長い | 60分以上 |
| 皆勤賞候補 | `CONSISTENT` | CalendarDays | 通塾日数が多い | 3日以上 |
| 長時間マスター | `MARATHON` | Timer | 1回あたりの平均滞在時間が長い | 0分超 |
| 急上昇 | `RISING_STAR` | Zap | 前期間比で学習時間が大幅増加 | 2時間以上 |

### C. 時間帯別計算の詳細ロジック

#### EARLY_BIRD / NIGHT_OWL の計算

時間帯別の滞在時間（`morningDuration`, `nightDuration`）は、以下のロジックで計算されます。

1. **時間帯クリッピング**: 各入退室ログを指定時間帯（朝: 4:00-9:00、夜: 20:00-24:00）に切り取り
   - 例: 3:50入室 → 8:00退室 の場合、朝の滞在時間は **4:00〜8:00 = 4時間** として計算
   - 深夜0:00〜3:59の滞在は EARLY_BIRD 対象外（4:00開始のため）

2. **オーバーラップのマージ**: 複数のログが時間帯内で重複する場合、マージして重複カウントを防止
   - 例: 05:00-07:00 と 06:00-08:30 → マージ後 05:00-08:30 = **3時間30分**
   - 単純加算（2h + 2.5h = 4.5h）ではなく、実際の滞在時間を正確に計算

```typescript
// 実装例: calculateDurationInTimeRange()
// 1. 各ログを時間帯に切り取り (clip)
// 2. 切り取ったインターバルをマージ (mergeIntervalsAndSum)
// 3. 合計分数を返却
```

### D. データ処理 (`src/services/badgeService.ts`)

1. **集計期間**: ローリング7日間（前日終了、毎日更新）
   - 終了日 = 前日 23:59:59 (JST)
   - 開始日 = 終了日の6日前 00:00:00 (JST)

2. **グループ分け**:
   - **受験生 (exam)**: 高3・既卒
   - **非受験生 (general)**: 上記以外の在塾生

3. **滞在時間の補完ロジック**:
   - 退室時刻が未記入 & 入室から12時間未満 → 現在時刻を仮の退室時刻
   - 退室時刻が未記入 & 入室から12時間以上 → `MIN(入室+4時間, 当日22:00)` で補完

4. **返却形式**:
```typescript
interface UnifiedWeeklyBadges {
    exam: StudentBadgesMap;           // 受験生のバッジ
    general: StudentBadgesMap;        // 非受験生のバッジ
    totalExamStudents: number;
    totalGeneralStudents: number;
    examRankings: StudentRankingsMap;     // 全受験生のランキング（1-indexed）
    generalRankings: StudentRankingsMap;  // 全非受験生のランキング
}
```

### E. UI表示

#### Occupancy ページ (`ChampionsCard`)
- 生徒向けに表示される週間ランキングカード
- ログインユーザーの属性に応じて「受験生部門」または「非受験生部門」を自動選択
- 講師・教室長は「受験生部門」をデフォルト表示

#### Dashboard ページ (`RankingWidget`)
- ランキングテーブル内にバッジアイコンを表示
- Lucide React アイコン使用

#### バッジスタイリング
受験生/非受験生で視覚的に差別化されたスタイリングが適用されます。

| 区分 | 背景色 | テキスト色 | 備考 |
| :--- | :--- | :--- | :--- |
| **受験生 (高3・既卒)** | Orange-50 (`#fff7ed`) | Orange-600 (`#ea580c`) | ゴールド風 |
| **非受験生** | Slate-100 (`#f1f5f9`) | Slate-600 (`#475569`) | シルバー風 |

```typescript
// src/features/dashboard/components/RankingDetailView.tsx
export const getBadgeStyle = (isExaminee: boolean) => {
    if (isExaminee) {
        return { background: '#fff7ed', color: '#ea580c', ... };
    }
    return { background: '#f1f5f9', color: '#475569', ... };
};
```

## 6. 実装済み追加機能

### A. 個人詳細ビュー (`RankingDetailView`)
ランキングの生徒行を展開すると、詳細な学習データを表示します。

**表示項目**:
- 獲得バッジ（受験生/非受験生でスタイル差別化）
- 合計学習時間
- 通塾日数
- 連続通塾日数（ストリーク）/ 最長連続日数
- 通塾状況ヒートマップ (`ActivityHeatmap`)
- 時間帯別滞在グラフ (`TimeRangeChart`)

**レスポンシブ対応**:
- PC: リッチなカードデザイン（GlassCard）
- モバイル: フラットなコンパクトデザイン

## 7. 今後の拡張予定 (Future Roadmap)
- **データエクスポート**: 表示中のデータをCSV等でダウンロードする機能
- **バッジ通知**: 新たにランクインした生徒にLINE通知を送信する機能

