# 講師・教室長用ダッシュボード (Teacher Dashboard) - 企画・要件定義

## 1. コンセプト (Concept)
**「努力の可視化 (Quantified Effort)」**

**学習時間（滞在時間）** と **通塾回数** の2軸で生徒の頑張りを定量化し、評価・称賛するためのツール。

## 2. 主要指標 (Key Metrics)
1.  **学習時間 (Study Duration)**: `退室 - 入室`。学習の「量」を測る。
2.  **通塾回数 (Visit Count)**: 「学校帰りに30分だけ」も評価する。学習の「習慣」を測る。

## 3. 画面・UI要件 (UI/UX Requirements)

### A. Dashboard Top (Overview)
教室全体の活気を一目で伝える。
- **KPI Cards**:
    - **総学習時間 (Total Hours)**: 今週/今月。前期間比のトレンド矢印（例: ↗ 12%）を表示。
    - **延べ来塾者数 (Total Visits)**: 今週/今月。
    - **最高記録 (Top Record)**: 今週最も長く勉強した生徒名と時間。
- **Ranking Widget**:
    - タブ切り替え: 「学習時間順」 / 「通塾回数順」
    - フィルター: 「全学年」 / 「高校生」 / 「中学生」
    - 行表示: 順位アイコン (🥇, 🥈, 🥉), 名前, 学年, 数値, バーグラフ(相対評価)。

### B. 生徒詳細モーダル (Student Detail Modal)
ランキングの行をクリックすると表示。個人の深掘り分析。
- **Profile**: 名前, 学年, 直近のステータス。
- **Activity Heatmap**: GitHub風の草生えるグラフ (Calendar Heatmap)。「いつ来たか」を視覚的に表現。
- **Daily Duration Chart**: 直近30日の学習時間棒グラフ。

## 4. アーキテクチャ・技術検討

### データ処理とキャッシュ
- **Backend API**: `/api/dashboard/stats`
- **Cache Strategy**: Google Sheetsへのアクセスは重いため、**1時間〜数時間のサーバーキャッシュ** (`unstable_cache`) を適用。
- **Calculation Logic (計算ロジック)**:
    - **基本式**: `滞在時間 = 退室時刻 - 入室時刻`
    - **欠損値補完 (Imputation Strategy)**:
        - `退室時刻` が空欄、または無効なデータの場合:
            1.  **入室から12時間未満**: 「現在も在室中」とみなし、現在時刻を仮の退室時刻とする。
            2.  **入室から12時間以上**: 「退室忘れ」とみなす。
                - **補正**: `MIN(入室時刻 + 4時間, 当日22:00)` を採用。
                - ※ 無制限にカウントされるのを防ぐため、最大でも4時間、または閉館時間(22:00)で打ち切る。

### ライブラリ選定
- **Charts**: `recharts` (React標準、軽量、カスタマイズ性高)
- **UI Components**: 既存の `GlassCard` 等を流用し、Glassmorphismデザインを踏襲。

## 5. MVPスコープ (Phase 1)
1.  **ダッシュボードページ (`/dashboard`)**: KPIカードとランキングの実装。
2.  **データ集計API**: DurationとCountの集計ロジック実装。
3.  **簡易詳細ビュー**: まずはモーダルなしで、ランキングのみでも可。余力があれば詳細モーダル。
